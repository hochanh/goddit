<!DOCTYPE html>
<html lang="en">

<head>
	<title>Welcome to reddit chat</title>
	<script type="text/javascript">
		window.onload = function() {
			var conn;
			var msg = document.getElementById("msg");
			var nick = document.getElementById("nick");
			var log = document.getElementById("log");
			var select = document.getElementById("room");
			var currentRoom = 'AskReddit';
			var serverAddress = "http://192.168.1.43:9000/";
			function loadHistory(room) {
				// clear the room messages first
				while (log.hasChildNodes()) {
					log.removeChild(log.lastChild);
				}
				fetch(serverAddress + "/history/" + room, {
					method: 'get'
				}).then(function(response) {
					console.log('loaded the history of ' + room + ' room');
					response.json().then(function(json) {
						if(json) {
							for (var i = 0; i < json.length; i++) {
								var item = document.createElement("li");
								var message = json[i];
								if (message.name === "Moderator") {
									message.color = "512DA8";
								} else if (message.name === "Anonymous") {
									message.color = "388E3C";
								} else if (message.name === {{.Username}}) {
									message.color = "1565C0";
								} else {
									message.color = "FF3D00";
								}
								item.setAttribute("class", "media");
								// template
								const Item = ({ name, text, color }) => `
										<div class="media-body">
											<div class="media">
												<a class="pull-left" href="#">
													<img class="media-object img-circle " src="http://placeskull.com/50/50/${color}">
												</a>
												<div class="media-body">
													${text}
													<br>
													<small class="text-muted">${name} | 23rd June at 5:00pm</small>
													<hr>
												</div>
											</div>
										</div>`;
								$(item).html([json[i]].map(Item).join(''));
								appendLog(item);
							}
						}
					});
				}).catch(function(err) {
					console.log(err);
				});
			}

			function appendLog(item) {
				// var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
				let firstChild = log.firstChild;
				log.insertBefore(item, firstChild);
				// let yCoords = $(item).offset().top;
				
				// $(log).scrollTop($(log).find("li").last().position().top);
				Array.from(document.querySelectorAll("#log li")).pop().scrollIntoView(true);
				// if (doScroll) {
				// 	log.scrollTop = log.scrollHeight - log.clientHeight;
				// }
			}
			loadHistory(currentRoom);
			connectWs(currentRoom);
			document.getElementById("submit").addEventListener("click", function(e) {
				e.preventDefault();
				if (!conn) {
					console.log('no Connection');
					return false;
				}
				if (!msg.value) {
					console.log('no Value');
					return false;
				}
				var json = {
					_id: '',
					text: msg.value,
					name: "{{ .Username }}",
					room_name: currentRoom,
					chatRoomId: '',
					level: 1
				};
				conn.send(JSON.stringify(json));
				msg.value = "";
				return false;
			}, false);
			// make a new websocket connection when switching rooms
			function connectWs(room) {
				if (window["WebSocket"]) {
					conn = new WebSocket("ws://" +
						document.location.host + "/room/" + room);
					conn.onopen = function(evt) {
						var item = document.createElement("li");
						item.innerHTML = "<em>Connected to " + room + "</em>";
						log.appendChild(item);
					}
					conn.onclose = function(evt) {
						var item = document.createElement("li");
						item.innerHTML = "<em>Connection to " + room + " closed</em>";
						log.appendChild(item);
					};
					conn.onmessage = function(evt) {
						var message = JSON.parse(evt.data);
						console.log("Got message: " + message.text);
						var item = document.createElement("li");
						if (message.name === "Moderator") {
							message.color = "512DA8";
						} else if (message.name === "Anonymous") {
							message.color = "388E3C";
						} else if (message.name === {{.Username}}) {
							message.color = "1565C0";
						} else {
							message.color = "FF3D00";
						}
						item.setAttribute("class", "media");
						// template
						const Item = ({ name, text, color }) => `
								<div class="media-body">
									<div class="media">
										<a class="pull-left" href="#">
											<img class="media-object img-circle " src="http://placeskull.com/50/50/${color}">
										</a>
										<div class="media-body">
											${text}
											<br>
											<small class="text-muted">${name} | 23rd June at 5:00pm</small>
											<hr>
										</div>
									</div>
								</div>`;
						$(item).html([message].map(Item).join(''));
						log.appendChild(item);
						item.scrollIntoView(true);
					};
				} else {
					var item = document.createElement("li");
					item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
					log.appendChild(item);
				}
			}

		document.getElementById("rooms").addEventListener("click", function(e) {
			if(e.target && e.target.nodeName == "A") {
				e.preventDefault();
				conn.close();
				connectWs(e.target.text);
				loadHistory(e.target.text);
				currentRoom = e.target.text;
			}
		}, false);
		
		$('#msg').on('keydown', function (e) {
			if (e.keyCode === 13) { // pressed enter
        e.preventDefault();
        if (!conn) {
					console.log('no Connection');
					return false;
				}
				if (!msg.value) {
					console.log('no Value');
					return false;
				}
				let name = '{{ .Username }}';
				var json = {
					_id: '',
					text: msg.value,
					name,
					room_name: currentRoom,
					chatRoomId: '',
					level: 1
				};
				conn.send(JSON.stringify(json));
				msg.value = "";
				return false;
        }
		});
	}
	</script>
	<script id="hidden-template" type="text/x-custom-template">

	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" crossorigin="anonymous"></script>
	<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<style type="text/css">
		.blue { background: blue }
		.grey { background: grey }
		.chats-row { height: 100vh; }
		.chats-row div { 
		    height: 50%;
		    border: 1px solid #ddd;
		    padding: 0px; 
		}
		.list-group-item {
		    border: none;
		    border-top: 1px solid #ddd;
		    border-bottom: 1px solid #ddd;
		    
		}
		.list-group-item:first-child {
		    border-top: none;
		    border-top-left-radius: 0px;
		    border-top-right-radius: 0px;
		}
		.current-chat { 
		    height: 100vh; 
		    border: 1px solid #ddd;
		}
		.chat-toolbar-row {
		    background-color: #f5f5f5;
		}
		.chat-toolbar {
		    margin-top: 10px;
		    margin-bottom: 10px;
		}
		.current-chat-area {
		    padding-top: 10px;
		    overflow: auto;
		    height: 85vh;
		}
		.current-chat-footer {
		    position: absolute;
		    bottom: 0;
		    
		}
		#rooms{
			height: auto;
			overflow-x: hidden;
			max-height: 100vh;
		}
	</style>
</head>

<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-3">
				<div class="row chats-row">
					<div class="media-list" id="rooms">
					{{range $i, $a := .Chatrooms}}
						<a href="#" class="list-group-item">{{ .Name }}</a>
					{{end}}
						<a href="#" class="list-group-item list-group-item-success">Current</a>
						<a href="#" class="list-group-item active">Prev</a>
					</div>
				</div>
			</div>
			<div class="col-md-9 current-chat">
				<div class="row chat-toolbar-row">
					<div class="col-sm-12">
						<div class="btn-group chat-toolbar" role="group" aria-label="...">
							<button id="chat-leave" class="btn btn-default ticket-option" type="button">
								<i class="glyphicon glyphicon-remove-sign"></i> Leave Chat
							</button>
							<button id="chat-invite" class="btn btn-default ticket-option" type="button">
								<i class="glyphicon glyphicon-plus"></i> Invite
							</button>
							<button id="chat-customer" class="btn btn-default ticket-option" type="button">
								<i class="glyphicon glyphicon-user"></i> Open Customer
							</button>
							<button id="chat-create-ticket" class="btn btn-default ticket-option" type="button">
								<i class="glyphicon glyphicon-pencil"></i> Create Ticket
							</button>
							<button id="chat-add-ticket" class="btn btn-default ticket-option" type="button">
								<i class="glyphicon glyphicon-plus"></i> Add to Ticket
							</button>
							<button id="chat-open-ticket" class="btn btn-default ticket-option" type="button">
								<i class="glyphicon glyphicon-open"></i> Open Ticket
							</button>
						</div>
					</div>
				</div>
				<div class="row current-chat-area">
					<div class="col-md-12">
						<ul class="media-list" id="log">
							<!-- CHAT MESSAGES -->
						</ul>
					</div>
				</div>
				<div class="row current-chat-footer">
					<div class="panel-footer">
						<div class="input-group">
							<input type="text" class="form-control" id="msg">
							<span class="input-group-btn">
					<button class="btn btn-default" type="button" id="submit">Send</button>
				  </span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>